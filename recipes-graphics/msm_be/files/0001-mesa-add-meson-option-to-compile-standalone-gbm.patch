From f971af900089e516a180eddd7f28c27f03aba481 Mon Sep 17 00:00:00 2001
From: Devanshi Bansal <quic_devanshi@quicinc.com>
Date: Fri, 27 Jun 2025 14:17:36 +0530
Subject: [PATCH] mesa add meson option to compile standalone gbm

Upstream-Status: Inappropriate [Downstream]
---
 include/meson.build  | 2 +-
 meson.build          | 5 +++++
 meson_options.txt    | 9 ++++++++-
 src/util/meson.build | 2 +-
 4 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/include/meson.build b/include/meson.build
index a955ac7..d5cb317 100644
--- a/include/meson.build
+++ b/include/meson.build
@@ -99,7 +99,7 @@ if with_osmesa
   install_headers('GL/osmesa.h', subdir : 'GL')
 endif
 
-if with_dri
+if not get_option('standalone_gbm') and with_dri
   install_headers('GL/internal/dri_interface.h', subdir : 'GL/internal')
 endif
 
diff --git a/meson.build b/meson.build
index 8963b31..43477a1 100644
--- a/meson.build
+++ b/meson.build
@@ -434,6 +434,11 @@ if not (with_dri or with_gallium or with_glx != 'disabled')
   with_shared_glapi = false
 endif
 
+standalone_gbm = get_option('standalone_gbm')
+if standalone_gbm
+  with_dri = true
+endif
+
 with_gbm = get_option('gbm') \
   .require(system_has_kms_drm, error_message : 'GBM only supports DRM/KMS platforms') \
   .disable_auto_if(not with_dri) \
diff --git a/meson_options.txt b/meson_options.txt
index 500a2eb..9353c4e 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -1,6 +1,13 @@
 # Copyright Â© 2017-2019 Intel Corporation
 # SPDX-License-Identifier: MIT
 
+option(
+  'standalone_gbm',
+  type : 'boolean',
+  value : false,
+  description : 'Compile GBM standalone. Default: false',
+)
+
 option(
   'platforms',
   type : 'array',
@@ -682,4 +689,4 @@ option(
   description : 'Build custom xmlconfig (driconf) support. If disabled, ' +
                 'the default driconf file is hardcoded into Mesa. ' +
                 'Requires expat.'
-)
\ No newline at end of file
+)
diff --git a/src/util/meson.build b/src/util/meson.build
index eb88f23..00a9a92 100644
--- a/src/util/meson.build
+++ b/src/util/meson.build
@@ -298,7 +298,7 @@ idep_mesautil = declare_dependency(
 )
 
 # Only install the drirc file if we build with support for parsing drirc files
-if use_xmlconfig
+if not standalone_gbm and use_xmlconfig
    install_data(files_drirc, install_dir : join_paths(get_option('datadir'), 'drirc.d'), install_tag : 'runtime')
 endif
 
-- 
2.34.1

